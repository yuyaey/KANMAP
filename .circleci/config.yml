version: 2.1
jobs:
 build:
   docker:
   - image: circleci/ruby:2.6.3-node-browsers
     environment:
       RAILS_ENV: test
   - image: circleci/mysql:8.0
     command: mysqld --default-authentication-plugin=mysql_native_password
     environment:
       MYSQL_DATABASE: KANMAP_test
       MYSQL_ALLOW_EMPTY_PASSWORD: true
       MYSQL_ROOT_HOST: '%'
       MYSQL_USER: root
       MYSQL_ROOT_PASSWORD: '136445yY$'
       MYSQL_PORT: 3306
   working_directory: ~/KANMAP
   steps:
   - checkout
   - restore_cache:
       keys:
       - v1-dependencies-{{ checksum "Gemfile.lock" }}
       - v1-dependencies-
   - run:
       name: install dependencies
       command: |
         gem install bundler -v 1.17.3
         bundle install --jobs=4 --retry=3 --path vendor/bundle
   - save_cache:
       paths:
       - ./vendor/bundle
       key: v1-dependencies-{{ checksum "Gemfile.lock" }}
   # Database setup
   - run:
       name: Prepare db
       command: |
         bundle exec rails db:schema:load --trace
   # Align chrome-driver's version installed by webdriver
   - run:
       name: Update ChromeDriver Version
       command: |
         bundle exec rake webdrivers:chromedriver:update
   # run tests!
   - run:
       name: Run rspec
       command: |
         mkdir /tmp/test-results
         TEST_FILES="$(circleci tests glob "spec/**/*_spec.rb" | circleci tests split --split-by=timings)"
         bundle exec bin/rspec --format progress --color --format documentation

   # collect reports
   - store_test_results:
       path: /tmp/test-results
   - store_artifacts:
       path: /tmp/test-results
       destination: test-results